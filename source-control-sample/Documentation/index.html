<!DOCTYPE html><html class="default" lang="en"><head><meta charset="utf-8"/><meta name="keywords" content="@playform/document"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>source-control-sample</title><meta name="description" content="Documentation for source-control-sample"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><link rel="stylesheet" href="assets/custom.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">source-control-sample</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h2>source-control-sample</h2></div><div class="tsd-panel tsd-typography"><a id="md:source-control-sample" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Source Control Sample<a href="#md:source-control-sample" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This sample implements a minimal source control provider. It shows how the
source control experience in VS Code could be used to for example interact with
code in JSFiddle.</p>
<p><img src="media/demo.gif" alt="alt text" title="Extension demo"></p>
<a id="md:vs-code-api" class="tsd-anchor"></a><h2 class="tsd-anchor-link">VS Code API<a href="#md:vs-code-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Following VS Code APIs are demonstrated by this extension:</p>
<ul>
<li><code>workspace.workspaceFolders</code></li>
<li><code>scm.createSourceControl</code></li>
<li><code>SourceControl</code></li>
<li><code>SourceControlResourceGroup</code></li>
<li><code>TextDocumentContentProvider</code></li>
</ul>
<a id="md:running-the-sample" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Running the Sample<a href="#md:running-the-sample" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Activate the extension by invoking the <code>Open JSFiddle</code> command, specify the
JSFiddle code, if no workspace folder is open, select a workspace folder. This
invokes following 4 lines, which does the following:</p>
<ol>
<li>creates the custom source control provider associated with the workspace
folder</li>
<li>creates the source control resource group to later show the local changes to
the files in the repository</li>
<li>registers the <code>quickDiffProvider</code>, which implements the mapping between the
documents in the remote repository and documents in the local folder.</li>
</ol>
<pre><code class="javascript"><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-2">jsFiddleScm</span><span class="hl-1"> = </span><span class="hl-2">vscode</span><span class="hl-1">.</span><span class="hl-2">scm</span><span class="hl-1">.</span><span class="hl-3">createSourceControl</span><span class="hl-1">(</span><br/><span class="hl-1">	</span><span class="hl-4">&quot;jsfiddle&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-4">&quot;JSFiddle #&quot;</span><span class="hl-1"> + </span><span class="hl-2">fiddle</span><span class="hl-1">.</span><span class="hl-2">slug</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-2">workspaceFolder</span><span class="hl-1">.</span><span class="hl-2">uri</span><span class="hl-1">,</span><br/><span class="hl-1">);</span><br/><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-2">changedResources</span><span class="hl-1"> = </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-2">jsFiddleScm</span><span class="hl-1">.</span><span class="hl-3">createResourceGroup</span><span class="hl-1">(</span><br/><span class="hl-1">	</span><span class="hl-4">&quot;workingTree&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-4">&quot;Changes&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">);</span><br/><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-2">fiddleRepository</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">FiddleRepository</span><span class="hl-1">(</span><span class="hl-2">workspaceFolder</span><span class="hl-1">, </span><span class="hl-2">fiddle</span><span class="hl-1">.</span><span class="hl-2">slug</span><span class="hl-1">);</span><br/><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-2">jsFiddleScm</span><span class="hl-1">.</span><span class="hl-2">quickDiffProvider</span><span class="hl-1"> = </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-2">fiddleRepository</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p><img src="media/source_control_view.PNG" alt="alt text" title="Source control view"></p>
<p>See <code>fiddleSourceControl.ts</code> for full code listing.</p>
<p>The three commands (command, roll-back and refresh) in the title of the source
control view pane are configured this way:</p>
<pre><code class="JSON"><span class="hl-4">&quot;contributes&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-5">&quot;commands&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">        </span><span class="hl-6">...</span><br/><span class="hl-1">    ],</span><br/><span class="hl-1">    </span><span class="hl-5">&quot;menus&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">        </span><span class="hl-5">&quot;scm/title&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">            {</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;command&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;extension.source-control.commit&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;group&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;navigation&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;when&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;scmProvider == jsfiddle&quot;</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">            {</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;command&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;extension.source-control.discard&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;group&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;navigation&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;when&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;scmProvider == jsfiddle&quot;</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">            {</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;command&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;extension.source-control.refresh&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;group&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;navigation&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;when&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;scmProvider == jsfiddle&quot;</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">            {</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;command&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;extension.source-control.browse&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-5">&quot;when&quot;</span><span class="hl-1">: </span><span class="hl-4">&quot;scmProvider == jsfiddle&quot;</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        ]</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">},</span>
</code><button type="button">Copy</button></pre>

<p>Note that the <code>extension.source-control.browse</code> command is intentionally missing
the <code>&quot;group&quot;: &quot;navigation&quot;</code> placement specification, which makes it show up
under the [dot dot dot] button.</p>
<p>It is also worth noting that the sample extension needs to overcome reloading
that VS Code triggers when a new workspace folder is added. This could be done
either by writing a memo into the <code>context.globalState</code>, or a configuration file
into the workspace folder and reading it upon the next extension activation. The
selected solution is to use <code>.jsfiddle</code> configuration file as described below.</p>
<a id="md:status-bar-controls" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Status bar controls<a href="#md:status-bar-controls" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The custom source control can add its own controls to the status bar. This
typically needs to be refreshed every time a new version/branch is checked-out.</p>
<pre><code class="javascript"><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-2">jsFiddleScm</span><span class="hl-1">.</span><span class="hl-2">statusBarCommands</span><span class="hl-1"> = [</span><br/><span class="hl-1">	{</span><br/><span class="hl-1">		</span><span class="hl-4">&quot;command&quot;</span><span class="hl-2">:</span><span class="hl-1"> </span><span class="hl-4">&quot;extension.source-control.checkout&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-4">&quot;title&quot;</span><span class="hl-2">:</span><span class="hl-1"> </span><span class="hl-4">`↕ </span><span class="hl-0">${</span><span class="hl-0">this</span><span class="hl-7">.</span><span class="hl-2">fiddle</span><span class="hl-7">.</span><span class="hl-2">slug</span><span class="hl-0">}</span><span class="hl-4"> #</span><span class="hl-0">${</span><span class="hl-0">this</span><span class="hl-7">.</span><span class="hl-2">fiddle</span><span class="hl-7">.</span><span class="hl-2">version</span><span class="hl-0">}</span><span class="hl-4"> / </span><span class="hl-0">${</span><span class="hl-0">this</span><span class="hl-7">.</span><span class="hl-2">latestFiddleVersion</span><span class="hl-0">}</span><span class="hl-4">`</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-4">&quot;tooltip&quot;</span><span class="hl-2">:</span><span class="hl-1"> </span><span class="hl-4">&quot;Checkout another version of this fiddle.&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">];</span>
</code><button type="button">Copy</button></pre>

<p><img src="media/status_bar.PNG" alt="alt text" title="Status bar integration"></p>
<p>The command <code>extension.source-control.checkout</code> displays quick pick of the
JSFiddle versions to check-out.</p>
<a id="md:populating-changed-files-view" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Populating changed files view<a href="#md:populating-changed-files-view" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The extension listens to changes to files in the workspace folder and compares
the new document text to the version originally checked out from the repository.
When it differs, it creates <code>vscode.SourceControlResourceState</code> for every
changed document assigns such list to <code>this.changedResources.resourceStates</code>,
where the <code>this.changedResources</code> was created earlier.</p>
<pre><code class="javascript"><span class="hl-1">{</span><br/><span class="hl-1">    </span><span class="hl-8">resourceUri</span><span class="hl-1">: </span><span class="hl-2">doc</span><span class="hl-1">.</span><span class="hl-2">uri</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-8">command</span><span class="hl-1">: {</span><br/><span class="hl-1">        </span><span class="hl-8">title</span><span class="hl-1">: </span><span class="hl-4">&quot;Show changes&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-8">command</span><span class="hl-1">: </span><span class="hl-4">&quot;vscode.diff&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-8">arguments</span><span class="hl-1">: [</span><span class="hl-2">repositoryUri</span><span class="hl-1">, </span><span class="hl-2">doc</span><span class="hl-1">.</span><span class="hl-2">uri</span><span class="hl-1">, </span><span class="hl-4">`Checked-out version ↔ Local changes`</span><span class="hl-1">],</span><br/><span class="hl-1">        </span><span class="hl-8">tooltip</span><span class="hl-1">: </span><span class="hl-4">&quot;Diff your changes&quot;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>where <code>repositoryUri</code> is determined by</p>
<pre><code class="javascript"><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-2">fiddleRepository</span><span class="hl-1">.</span><span class="hl-3">provideOriginalResource</span><span class="hl-1">(</span><span class="hl-2">doc</span><span class="hl-1">.</span><span class="hl-2">uri</span><span class="hl-1">, </span><span class="hl-0">null</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="md:quick-diff" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Quick diff<a href="#md:quick-diff" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Both the regular diff (invoking the built-in <code>vscode.diff</code> when user clicks on
the changed resource in the source control view) and the Quick Diff (available
in the left margin of the text editor) are rendered automatically by VS Code as
long as the extension provides it with the content of the original document
checked out from the repository. This is done by implementing a
<code>TextDocumentContentProvider</code>.</p>
<p><img src="media/quick_diff.gif" alt="alt text" title="Quick diff"></p>
<a id="md:source-control-extension-activation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Source Control extension activation<a href="#md:source-control-extension-activation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>A source control extensions gets activated either when a remote repository gets
<em>cloned</em> upon user request, or when a previously <em>cloned</em> workspace folder is
open.</p>
<pre><code class="JSON"><span class="hl-1">    </span><span class="hl-4">&quot;activationEvents&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">        </span><span class="hl-4">&quot;workspaceContains:.jsfiddle&quot;</span><br/><span class="hl-1">    ],</span>
</code><button type="button">Copy</button></pre>

<p>This extension implements the <em>cloning</em> using the
<code>extension.source-control.open</code> command.</p>
<p>This sample extension stores the source control configuration in the <code>.jsfiddle</code>
JSON file in the workspace folder root.</p>
<p>This is done by storing the <code>.jsfiddle</code> configuration file into the
<code>WorkspaceFolder</code> just inserting the workspace folder via the
<code>vscode.workspace.updateWorkspaceFolders(...)</code> call, which seems to make the
extension re-activate. Upon the re-activation, the
<code>initializeFromConfigurationFile()</code> function scans all <code>WorkspaceFolder</code>s for
the <code>.jsfiddle</code> configuration files and re-creates the <code>SourceControl</code>
instances.</p>
<a id="md:multiple-workspace-folder-support" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Multiple workspace folder support<a href="#md:multiple-workspace-folder-support" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Source control extension should support multiple workspace folders bound to
different remote repositories.</p>
<p><img src="media/multi-workspace-folder.gif" alt="alt text" title="Multiple workspace folder support"></p>
<a id="md:testing-the-sample" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Testing the sample<a href="#md:testing-the-sample" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This sample can be tested on any JSFiddle with (e.g. <code>u8B29/1</code>) or without (e.g.
<code>u8B29</code>) the version number specified. However, if you want to test committing
code back to the repository, try typing in <code>demo</code> instead of a real fiddle name,
which lets you mock the repository without reading/writing from/to actual
JSFiddle.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#md:source-control-sample"><span>Source <wbr/>Control <wbr/>Sample</span></a><ul><li><a href="#md:vs-code-api"><span>VS <wbr/>Code API</span></a></li><li><a href="#md:running-the-sample"><span>Running the <wbr/>Sample</span></a></li><li><a href="#md:status-bar-controls"><span>Status bar controls</span></a></li><li><a href="#md:populating-changed-files-view"><span>Populating changed files view</span></a></li><li><a href="#md:quick-diff"><span>Quick diff</span></a></li><li><a href="#md:source-control-extension-activation"><span>Source <wbr/>Control extension activation</span></a></li><li><a href="#md:multiple-workspace-folder-support"><span>Multiple workspace folder support</span></a></li><li><a href="#md:testing-the-sample"><span>Testing the sample</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html" class="current"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="assets/icons.svg#icon-1"></use></svg><span>source-control-sample</span></a><ul class="tsd-small-nested-navigation" id="tsd-nav-container" data-base="."><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
